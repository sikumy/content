---
id: "csrf-vulnerability-with-no-defenses"
title: "CSRF vulnerability with no defenses – PortSwigger Write Up"
author: "juan-antonio-gonzalez-mena"
publishedDate: 2022-06-14
updatedDate: 2022-06-14
image: "https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-0.webp"
description: "Aprende a explotar una vulnerabilidad CSRF sin defensas en PortSwigger Lab. Guía paso a paso para crear una página HTML maliciosa que cambie el email de la víctima mediante Cross-Site Request Forgery."
categories:
  - "portswigger-labs"
draft: false
featured: false
lang: "es"
---

En este post vamos a estar resolviendo el laboratorio: "CSRF vulnerability with no defenses".

![Pantalla de inicio del laboratorio CSRF vulnerability with no defenses](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-1.avif)

En este caso, el laboratorio nos indica que hay un CSRF en la funcionalidad de cambio de email. Para resolver el laboratorio, debemos crear una página HTML que se aproveche del CSRF para cambiar el email de quien visite nuestra web. Por último, se nos proporciona unas credenciales para acceder a una cuenta.

Sabiendo todo esto, iniciamos el laboratorio y nos dirigimos a “My account” para iniciar sesión:

![Botón My account para acceder al panel de usuario](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-2.avif)

![Formulario de inicio de sesión con credenciales](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-3.avif)

Una vez hemos iniciado sesión, se nos redirige por así decirlo a nuestro perfil:

![Panel de perfil del usuario con campo de actualización de email](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-4.avif)

Aquí, como mencionaba el enunciado, encontramos una funcionalidad para cambiar el email de nuestra cuenta, por lo que preparamos Burp Suite para interceptar la petición del cambio:

![Configuración del proxy en el navegador](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-5.avif)

![Interceptor de Burp Suite activado y en espera](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-6.avif)

Con Burp Suite preparado, colocamos un email aleatorio y le damos a `Update email`:

![Formulario de cambio de email con nuevo valor](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-7.avif)

Al momento de darle, Burp Suite recibe la petición:

![Petición POST interceptada en Burp Suite mostrando parámetro email](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-8.avif)

Y como podemos observar, el único parámetro que se envía en el cuerpo de la petición es `email`. No hay ningún parámetro más cuyo valor sea aleatorio e imposible de predecir, por lo que es posible crear una plantilla maliciosa que cree una petición como la que se puede ver arriba, teniendo en cuenta, que las cookies de un sitio son incluidas en cualquier petición que el navegador haga a ese sitio.

Si dejamos que esta petición se envíe, el email cambiará sin problemas:

![Confirmación de actualización de email exitosa](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-9.avif)

Ya sabemos toda la información necesaria y todo funciona como se espera, por lo que desactivamos el proxy y nos dirigimos al servidor del exploit:

![Botón para acceder al exploit server](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-10.avif)

![Interfaz del exploit server en PortSwigger](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-11.avif)

Una vez dentro tenemos los siguientes campos:

![Campos del exploit server para configurar el ataque](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-12.avif)

Es aquí donde creamos la plantilla HTML maliciosa que generará la petición que veíamos arriba cuando la víctima visite la página:

![Código HTML del exploit CSRF en el servidor](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-13.avif)

El código HTML es el siguiente:

```html
<html>
    <body>
        <form action='<URL donde se realiza el cambio del email>' method='<METODO HTTP>'>
            <input name="email" value="<nuevo valor, en este caso del email>" type="hidden"/>  
        </form>
        <script>
            document.forms[0].submit();
        </script>
    </body>
</html>
```

Si le damos a ver exploit, nosotros mismos visitaremos la página maliciosa:

![Vista previa del exploit antes de enviarlo](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-14.avif)

Como tenemos la sesión guardada en el navegador con las cookies, al visitarla, la petición se genera correctamente y el email es cambiado, todo a partir de solo visitar la web maliciosa:

![Email actualizado automáticamente tras visitar el exploit](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-15.avif)

Entonces, lo que ha ocurrido es:
- La web maliciosa genera una petición especialmente diseñada cuando se visita.
- Si el usuario está logueado en la web vulnerable (este caso), el navegador incluirá automáticamente la cookie de sesión en la petición (suponiendo que el atributo `SameSite` de la cookie no está habilitado, que no es este caso)
- La web maliciosa procesará la petición, ya que es imposible diferenciar si la ha hecho la propia víctima o no, por lo que la procesará sin problemas y se cambiará la dirección de email.

Como hemos observado que el exploit funciona perfectamente, simplemente podemos enviarlo a la víctima:

![Botón para entregar el exploit a la víctima](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-16.avif)

Y de esta manera, resolvemos el laboratorio:

![Mensaje de laboratorio resuelto satisfactoriamente](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-17.avif)

![Confirmación final de éxito del laboratorio](https://cdn.deephacking.tech/i/posts/portswigger-labs/csrf-vulnerability-with-no-defenses/csrf-vulnerability-with-no-defenses-18.avif)
