---
id: "escalada-de-privilegios-en-windows-con-exploits-de-kernel"
title: "Windows Privilege Escalation with Kernel Exploits"
author: "juan-antonio-gonzalez-mena"
publishedDate: 2021-12-02
updatedDate: 2021-12-02
image: "https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-0.webp"
description: "Learn to escalate privileges on Windows through kernel exploits, vulnerability enumeration, and tools like WESNG and Watson."
categories:
  - "windows"
draft: false
featured: false
lang: "en"
---

The kernel, being the core of any operating system and the layer between hardware and software, when exploited, results in everything being executed by the `SYSTEM` user (the user with the highest privileges in Windows systems).

The process to find and exploit kernel vulnerabilities is approximately as follows:

1. We enumerate the Windows version and patches --> `systeminfo`
2. We search for exploits associated with that version or patches
3. We compile and execute --> Compilation is not necessary if we download an already compiled exploit

We must be careful with kernel exploits, as they tend to be unstable, single-use, or cause a system crash. That's why this should be one of the last options for privilege escalation.

There are different tools that can help us identify this type of vulnerabilities:

- [Windows Exploit Suggester Next Generation](https://github.com/bitsadmin/wesng)
- [Watson](https://github.com/rasta-mouse/Watson)
- In metasploit: `windows/gather/enum_patches`
- Internet

Once we have enumerated what types of patches are missing or what vulnerabilities are affected, we can make use of [SecWiki](https://github.com/SecWiki/windows-kernel-exploits), which is a resource that contains a large number of already compiled kernel exploits.

That said, let's go with a practical case using "Windows Exploit Suggester Next Generation":

First of all, we need to obtain the `systeminfo`, which includes transferring it to our Kali machine. This part is simple, as we can do it in a single step. On our Linux (in my case, Kali) we run a Samba server:

![Samba server running](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-1.avif)

The argument `pwned` is the name of the shared resource, and the second argument `$(pwd)` is the way we indicate the path where the server will run, in this case, the current path (we could also indicate it with just a dot).

Having the server mounted, we go to Windows and simply redirect the command output to our server and shared resource:

![Redirecting systeminfo to the shared resource](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-2.avif)

We can confirm that there has been a connection if we go to Kali:

![Connection confirmation on Kali](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-3.avif)

This way, we now have the `systeminfo` output:

![Systeminfo command output part 1](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-4.avif)

![Systeminfo command output part 2](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-5.avif)

Having this, we are going to use "WESNG", first we need to update its database. It's very simple, we just run the following command:

![WESNG database update](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-6.avif)

With this, the CVE list will be updated.

The most basic command would simply be to specify the `systeminfo` file:

![WESNG basic command](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-7.avif)

Its output is too large to show

![Extensive WESNG output](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-8.avif)

But that's fine, we're going to use some arguments to only see what interests us. The structure that WESNG follows to display each CVE to which the Windows machine may be vulnerable is as follows:

![WESNG output structure](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-9.avif)

The field that interests us is the `Impact`. We can see the possible values of `Impact` using `grep` and `sort`:

![Possible values of the Impact field](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-10.avif)

In this way, if we look closely, there is a value of this field that may be the one we are interested in filtering by. I'm talking about "Elevation of Privilege", as that is what we want to achieve.

Knowing this, we can specify to "WESNG" to only show us the CVEs whose impact is a privilege escalation:

![Filtering by privilege escalation](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-11.avif)

This way, we have just gone from 31883 lines to:

![Number of reduced lines](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-12.avif)

Which is still a lot, but now it's our job to find the exploit to use. There is another filter that may interest us, since "WESNG" shows some CVEs without "Exploits" (which, be careful, doesn't mean there aren't any, but at least it doesn't have any associated):

![CVEs without associated exploits](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-13.avif)

If we are not interested in seeing CVEs that don't have any associated exploit, we can filter the search by adding the `--exploits-only` argument:

![Filtering with exploits-only](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-14.avif)

If we now see the number of lines, we have gone down much more:

![Number of lines after filtering](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-15.avif)

So far, possible filters that may interest us when searching for CVEs in "WESNG". Even so, the tool has a fairly complete help panel with many more options.

At this point, the exploit to choose will depend on us, with experience there will be CVEs that ring a bell and we'll get straight to the point to test those according to the operating system. This is achieved with time and effort.

In my case, I'm going to use "CVE-2019-1458", which, be careful, Windows 7 is vulnerable to, and we can find exploits, however, "WESNG" indicates that it doesn't have any associated, so if we had used the `--exploits-only` argument, it would have discarded it, despite being vulnerable:

![CVE-2019-1458 without associated exploits in WESNG](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-16.avif)

Having located the CVE, we are going to go to SecWiki to see if it has the compiled exploit:

![SecWiki repository](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-17.avif)

![SecWiki repository content](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-18.avif)

In this case, SecWiki doesn't have any exploit in the repository. However, in the README.md it indicates another repository which does contain an exploit for this CVE:

![Alternative repository with exploit](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-19.avif)

It is typical that in privilege escalation exploit repositories we are given a PoC (Proof of Concept) of the exploit:

![Proof of Concept of the exploit](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-20.avif)

In this case, we see two things:

1. The exploit can only be executed once per system boot (this can indicate the resulting instability of the exploit in the system).
2. The exploit follows the structure of:
    1. `cve-2019-1458.exe <command to execute>`

Knowing this and having downloaded the exploit binary on Windows 7:

![Downloaded exploit binary](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-21.avif)

We are going to escalate privileges.

We set up a Samba server on our Kali, in addition to listening:

![Samba server and listener on Kali](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-22.avif)

> Note: the directory where we are running the Samba server contains the binary "nc.exe" (netcat for Windows)

Now, we return to Windows 7, and we will execute the following command using the exploit:

![Exploit execution on Windows](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-23.avif)

This way, returning to Kali:

![Shell as SYSTEM obtained](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-24.avif)

We get a shell as "nt authority\\system".

In the repository it was indicated that it was only a single-use exploit per boot, we can confirm it:

![Confirmation of single use](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-25.avif)

Such is the instability of, in this case, this exploit (and in general, of exploits that take advantage of the kernel), that when we shut down the machine we get the following:

![Error when shutting down the system](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-26.avif)

This clearly doesn't happen with all exploits, but we can observe the delicacy of dealing with the kernel.

Going back to the tools mentioned at the beginning:

- [Windows Exploit Suggester Next Generation](https://github.com/bitsadmin/wesng)
- [Watson](https://github.com/rasta-mouse/Watson)
- In metasploit: `windows/gather/enum_patches`
- Internet

We can use whichever we like best, Watson for example in this case doesn't give us anything:

![Watson without results](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-27.avif)

The metasploit module also helps us in this task:

![Metasploit module for patch enumeration](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-28.avif)

In this case it doesn't give us any significant output. If it detected any possible vulnerability it would indicate it as follows:

<figure>

![Vulnerability detection with Metasploit](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-29.avif)

<figcaption>

Reference: https://pentestlab.blog/2017/04/24/windows-kernel-exploits/

</figcaption>

</figure>

Last but not least, another tool to keep in mind is the internet itself.

When we run `systeminfo` we obtain enough information to search on Google for any vulnerability that affects the Operating System and Version:

![Vulnerability search on Google](https://cdn.deephacking.tech/i/posts/escalada-de-privilegios-en-windows-con-exploits-de-kernel/escalada-de-privilegios-en-windows-con-exploits-de-kernel-30.avif)

In this way, although we can rely on different tools, in the end manual work and our own research will be what results in a successful privilege escalation.
