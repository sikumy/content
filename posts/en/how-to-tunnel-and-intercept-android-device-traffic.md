---
id: "tunelizar-e-interceptar-trafico-android"
title: "How to Tunnel and Intercept Android Device Traffic"
author: "pablo-castillo"
publishedDate: 2023-02-27
updatedDate: 2023-02-27
image: "https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-0.webp"
description: "Learn how to configure Burp Suite to intercept network traffic from an Android device by installing system certificates and configuring the HTTP proxy."
categories:
  - "mobile-pentesting"
draft: false
featured: false
lang: "en"
---

The goal of this post is to learn how to configure our environment to intercept network traffic generated by an Android device and analyze and modify it. To do this, we will need to use an HTTP proxy server that acts as an intermediary between the smartphone and a web server. In our case, we will use one of the most well-known software in the pentesting industry: _Burp Suite_.

- [Burp Suite and Certificates on Android](#burp-suite-and-certificates-on-android)
- [Installing the Certificate on the System](#installing-the-certificate-on-the-system)
- [Configuring the Android Proxy - Burp Suite](#configuring-the-android-proxy---burp-suite)
- [Possible Errors When Configuring Android Partitions in Write Mode](#possible-errors-when-configuring-android-partitions-in-write-mode)
- [References](#references)

## Burp Suite and Certificates on Android

I don't think it needs an introduction, but just in case, _Burp Suite_ is a tool used for security testing of web applications. It intercepts HTTP requests made by a web server or application to analyze, modify, accept, reject them, and many other options.

There are two versions of this software: _Burp Suite Community Edition_ (free version) and _Burp Suite Professional_ (paid version). Although the paid version is much better and more complete than the free one, with the latter we can work perfectly in any scenario. However, the tool will run slower and we won't be able to use the many add-ons of the paid version. You can download them through the following links:

- [Download Burp Suite Community Edition for free](https://portswigger.net/burp/communitydownload)
- [Download Burp Suite Professional](https://portswigger.net/burp/pro)

If you have used this software before, you will know that it is necessary to install a trusted certificate so that the browser does not generate errors when working under the HTTPS protocol. Well, to intercept the traffic from our Android device, we will also have to install that certificate (as expected).

On all devices there are two types of credential stores or _Trusted Credentials_, which are: System and User. These two panels store the certificates that the phone trusts. To access these panels, within the device we will enter:

- _Settings â†’ Passwords and security â†’ Encryption and credentials â†’ Trusted credentials_

![Trusted credentials configuration on Android](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-1.avif)

If a user installs a certificate, it is stored in the User Credentials section. Previously, a person would import the certificate generated by _Burp Suite_ and install it on their Android and could already intercept traffic without any problem. However, starting with Android version 7 (_Nougat_), the way Android trusts certificates changed, and it only does so for those installed in the System (unless there is a special configuration in the user certificate). That is why we are going to see how we can install the certificate generated by our proxy server in the appropriate place for its correct use.

## Installing the Certificate on the System

To begin the process, we must have started our Android device with _Android Studio_ along with _Burp Suite_. If you don't know what I'm referring to, you can review my previous article:

- [Creating a Work Environment â€“ Android Pentesting](https://blog.deephacking.tech/en/posts/creating-android-work-environment/)

Once we have the device started, the next step will be, within the proxy server, to access the tabs:

- _Proxy â†’ Proxy Settings â†’ Import/Export CA Certificate â†’ Certificate in DER format_

![Export certificate in Burp Suite](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-2.avif)

We will save this certificate under the name _cacert.der_ in the same _platform-tools_ folder (for convenience, to have everything in the same folder). The certificates found in the device system have the _subject\_hash\_old.0_ nomenclature, so we will have to modify it using the _OpenSSL_ software that you can find at the following link:

- [Download OpenSSL for Windows](https://slproweb.com/products/Win32OpenSSL.html)

This program has a toolkit with functions and algorithms to create cryptographic systems and digital certificates. Once the installation is complete, the steps to follow will be:

1. Modify the certificate format from DER to PEM.

```bash
openssl x509 -inform DER -in cacert.der -out cacert.pem
```

2. Obtain the subject\_hash\_old hash value of the generated certificate.

```bash
openssl x509 -inform PEM -subject_hash_old -in cacert.pem
```

3. Rename the certificate with the previously mentioned nomenclature subject\_hash\_old.0.

```bash
move cacert.pem <hash>.0
```

In my case, the process looks like this:

![Certificate conversion with OpenSSL](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-3.avif)

![Obtaining the certificate hash](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-4.avif)

Well, after these operations we have already completed half the work with the certificate in the necessary format to move it to the device. The next thing we will do is start working with the _adb_ tool following the following procedure:

1. Start _adb_ and make sure we are operating as root.

```bash
adb.exe
adb root
```

2. Set the _/system_ partition to write mode, since by default it is in read mode. This step is very important.

```bash
adb remount
```

At the end of this article I explain alternatives to this command, in case you have any errors.

3. Copy the certificate into our Android.

```bash
adb push <cert>.0 /sdcard/
adb shell
```

4. Modify the permissions of said certificate.

```bash
chmod 644 /sdcard/<cert>.0
```

5. Copy it to the folder where the certificates verified by the system are located.

```bash
mv /sdcard/<cert>.0 /system/etc/security/cacerts/
```

It would look something like this:

![adb commands to install the certificate](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-5.avif)

If we now access the _Trusted Credentials_ section in the device settings, we can find in _system_ how the _PortSwigger_ certificate has been added:

![PortSwigger certificate in system credentials](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-6.avif)

Done! Let's finish the process ðŸ™‚.

## Configuring the Android Proxy - Burp Suite

To finish the process, in the same tab where the certificate export was located in _Burp Suite_, we will edit the listener we are going to use and select the main local IP address, in my case the WiFi adapter IP to use in the proxy:

![Configuring the listener in Burp Suite](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-7.avif)

![Selecting the WiFi adapter IP address](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-8.avif)

Now we will do the same on the Android device, we will select the WiFi network and configure it to add a manual proxy as shown in the following images:

<div class="grid grid-cols-3 gap-4">
<div>

![WiFi network configuration on Android](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-9.avif)

</div>
<div>

![Manual proxy configuration on Android](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-10.avif)

</div>
<div>

![HTTP proxy parameters on Android](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-11.avif)

</div>
</div>

Once we have completed this configuration, it is now possible to intercept traffic from our phone through _Burp Suite_:

![HTTP traffic interception in Burp Suite](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-12.avif)

![HTTPS traffic intercepted correctly](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-13.avif)

## Possible Errors When Configuring Android Partitions in Write Mode

I decided to write this section to try to save each of you the desperation and frustration that I experienced during my learning in Android audits (which of course continues) with the countless errors I encountered when configuring write mode on the _/system_ partition.

In addition to the previously mentioned method using the _adb remount_ command, another equally well-known alternative is the following:

```bash
adb shell mount -o rw,remount,rw /system // Set the partition to write mode
adb shell mount -o ro,remount,rw /system // Return the partition to read mode
```

However, on some occasions, depending on the Android version used or the device being emulated, I encountered a series of errors that prevented me from performing this step. Some of the errors I encountered are the following:

- '/dev/block/pci/pci0000:00/0000:00:03.0/by-name/system' is read-only

- mount: '/system' not in /proc/mounts

- '/dev/root' is read-only

- /system/bin/sh: avbctl: not found

- remount of the / superblock failed: Permission denied

- mount: '/dev/block/pci/pci0000:00/0000:00:03.0/by-name/system'->'/system': Device or resource busy

- mount: Device or resource busy

These errors have been obtained using different commands from the cmd and from the internal Android shell (most in the latter).

After having performed different tests and having verified it on different devices and versions of Android, I have found a solution that to date has worked for me on all occasions. The process consists of running the Android emulator from the cmd and adding an option so that from its execution the partitions have write permission. This way, you don't have to modify the emulator once it's started because the option is implemented from its launch. The process to carry it out will be as follows:

1. Access the Android\_SDK folder where the emulated Android Studio devices are located.

```bash
cd C:\Tools\Android_SDK\emulator // Find the directory on your PC
```

2. List the created emulators to know which one to run.

```bash
emulator -list-avds
```

3. Run the emulator with the -writable-system flag

```bash
emulator -avd -writable-system
```

The result would be as shown below:

![Running the emulator with writable-system](https://cdn.deephacking.tech/i/posts/tunelizar-e-interceptar-trafico-android/tunelizar-e-interceptar-trafico-android-14.avif)

Once this is done and the emulator has started, it is now possible to perform all the steps to copy the certificate to the specified folder.

I hope this helps you and you have no problems!

## References

- [Install System CA Certificate on Android Emulator](https://docs.mitmproxy.org/stable/howto-install-system-trusted-ca-android/)
- [Installing a new trusted SSL root certificate on Android](https://blog.jamie.holdings/2016/09/04/installing-a-new-trusted-ssl-root-certificate-on-android/)
- [How to make AVD system and file-system writable?](https://gist.github.com/interference-security/b786d349839ee5bf40bbd1bc2d240a59)
